<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Chatbot - Kisan Sahayak</title>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.5.0/font/bootstrap-icons.css">
    <link rel="stylesheet" href="../assets/css/dashboard.css">
    <link rel="stylesheet" href="../assets/css/navigation.css">
    <link rel="stylesheet" href="../assets/css/mobile-responsive.css">
    <link rel="stylesheet" href="../assets/css/ui-improvements.css">
    <style>
        :root {
            --bg-color: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            --text-color: #2d3748;
            --card-bg: rgba(255, 255, 255, 0.95);
            --header-bg: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --sidebar-bg: linear-gradient(180deg, #4c51bf 0%, #667eea 100%);
            --accent-color: #4f46e5;
            --hover-color: #3730a3;
            --success-color: #10b981;
            --warning-color: #f59e0b;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --border-radius: 16px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        body.dark {
            --bg-color: linear-gradient(135deg, #1a202c 0%, #2d3748 100%);
            --text-color: #e2e8f0;
            --card-bg: rgba(45, 55, 72, 0.95);
            --header-bg: linear-gradient(135deg, #2d3748 0%, #4a5568 100%);
            --sidebar-bg: linear-gradient(180deg, #1a202c 0%, #2d3748 100%);
            --accent-color: #818cf8;
            --hover-color: #6366f1;
        }

        body {
            margin: 0;
            padding: 0;
            background: var(--bg-color);
            color: var(--text-color);
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', 'Oxygen', 'Ubuntu', 'Cantarell', sans-serif;
            transition: var(--transition);
            font-size: 16px;
            line-height: 1.6;
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-color);
            z-index: -1;
        }

        .dashboard-header {
            background: var(--header-bg) !important;
            color: #fff;
            box-shadow: var(--shadow-lg);
            backdrop-filter: blur(20px) saturate(180%);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .dashboard-header h1 {
            color: #fff !important;
        }
        
        .dashboard-sidebar {
            background: var(--sidebar-bg) !important;
            color: #fff;
        }
        
        .dashboard-sidebar nav ul li a {
            color: #fff !important;
        }
        
        .dashboard-sidebar nav ul li a:hover {
            background: rgba(255, 255, 255, 0.2) !important;
            color: #fff !important;
        }
        
        .dashboard-sidebar nav ul li.active a {
            background: rgba(255, 255, 255, 0.2) !important;
            color: #fff !important;
        }

        .dashboard-main-content {
            margin-left: 280px !important;
            padding-top: 0 !important;
            overflow-x: hidden !important;
        }

        .content-wrapper {
            margin-top: 0 !important;
        }

        @media (max-width: 1024px) {
            .dashboard-main-content {
                margin-left: 0 !important;
            }
        }

        /* Dark Mode Toggle Styling */
        .dark-toggle {
            position: absolute;
            bottom: 2rem;
            left: 1.5rem;
            right: 1.5rem;
            padding: 15px 25px;
            background: rgba(255, 255, 255, 0.15);
            color: #fff;
            border-radius: 30px;
            border: 2px solid rgba(255, 255, 255, 0.3);
            text-align: center;
            cursor: pointer;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            font-weight: 600;
            font-size: 0.95rem;
            backdrop-filter: blur(20px) saturate(180%);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15);
            position: relative;
            overflow: hidden;
            user-select: none;
        }

        .dark-toggle::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.2), transparent);
            transition: left 0.6s ease;
        }

        .dark-toggle:hover {
            background: rgba(255, 255, 255, 0.25);
            transform: translateY(-3px);
            box-shadow: 0 12px 30px rgba(0, 0, 0, 0.2);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .dark-toggle:hover::before {
            left: 100%;
        }

        .dark-toggle:active {
            transform: translateY(-1px);
            box-shadow: 0 6px 15px rgba(0, 0, 0, 0.2);
        }

        @media (max-width: 768px) {
            .dark-toggle {
                margin: 15px 20px;
                padding: 12px 20px;
                font-size: 0.9rem;
            }
        }

        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-color);
            z-index: -1;
        }

        .dashboard-header {
            background: var(--header-bg) !important;
            color: #fff;
            box-shadow: var(--shadow-lg);
            backdrop-filter: blur(20px) saturate(180%);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }
        
        .dashboard-header h1 {
            color: #fff !important;
        }
        
        .dashboard-sidebar {
            background: var(--sidebar-bg) !important;
            color: #fff;
        }
        
        .dashboard-sidebar nav ul li a {
            color: #fff !important;
        }
        
        .dashboard-sidebar nav ul li a:hover {
            background: rgba(255, 255, 255, 0.2) !important;
            color: #fff !important;
        }
        
        .dashboard-sidebar nav ul li.active a {
            background: rgba(255, 255, 255, 0.2) !important;
            color: #fff !important;
        }

        .dashboard-main-content {
            margin-left: 280px !important;
            padding-top: 0 !important;
            overflow-x: hidden !important;
        }

        .content-wrapper {
            margin-top: 0 !important;
        }

        @media (max-width: 1024px) {
            .dashboard-main-content {
                margin-left: 0 !important;
            }
        }

    </style>
    <style>
        .chatbot-container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 2rem;
            height: calc(100vh - 100px);
            display: flex;
            flex-direction: column;
        }
        
        .chatbot-header {
            text-align: center;
            margin-bottom: 2rem;
        }
        
        .chatbot-header h1 {
            color: #4f46e5;
            margin-bottom: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }
        
        .chat-interface {
            flex: 1;
            display: flex;
            flex-direction: column;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 16px;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            overflow: hidden;
            backdrop-filter: blur(20px);
        }
        
        .chat-header {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            padding: 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
        }
        
        .chat-avatar {
            width: 50px;
            height: 50px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }
        
        .chat-info h3 {
            margin: 0;
            font-size: 1.2rem;
        }
        
        .chat-info p {
            margin: 0;
            opacity: 0.9;
            font-size: 0.9rem;
        }
        
        .chat-messages {
            flex: 1;
            padding: 1.5rem;
            overflow-y: auto;
            background: #f8fafc;
            display: flex;
            flex-direction: column;
            gap: 1rem;
        }
        
        .message {
            display: flex;
            gap: 0.75rem;
            max-width: 80%;
            animation: fadeInUp 0.3s ease;
        }
        
        .message.user {
            align-self: flex-end;
            flex-direction: row-reverse;
        }
        
        .message-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
        }
        
        .message.bot .message-avatar {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
        }
        
        .message.user .message-avatar {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }
        
        .message-content {
            background: white;
            padding: 1rem 1.25rem;
            border-radius: 18px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
            position: relative;
        }
        
        .message.user .message-content {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
        }
        
        .message-time {
            font-size: 0.75rem;
            opacity: 0.6;
            margin-top: 0.5rem;
        }
        
        .chat-input-area {
            padding: 1.5rem;
            background: white;
            border-top: 1px solid #e5e7eb;
        }
        
        .input-container {
            display: flex;
            gap: 0.75rem;
            align-items: flex-end;
        }
        
        .input-wrapper {
            flex: 1;
            position: relative;
        }
        
        .chat-input {
            width: 100%;
            padding: 1rem 3rem 1rem 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 25px;
            font-size: 1rem;
            resize: none;
            min-height: 50px;
            max-height: 120px;
            transition: all 0.3s ease;
            font-family: inherit;
        }
        
        .chat-input:focus {
            outline: none;
            border-color: #4f46e5;
            box-shadow: 0 0 0 3px rgba(79, 70, 229, 0.1);
        }
        
        .voice-btn {
            position: absolute;
            right: 0.75rem;
            top: 50%;
            transform: translateY(-50%);
            background: none;
            border: none;
            color: #6b7280;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 50%;
            transition: all 0.3s ease;
        }
        
        .voice-btn:hover {
            background: #f3f4f6;
            color: #4f46e5;
        }
        
        .voice-btn.listening {
            color: #ef4444;
            animation: pulse 1s infinite;
        }
        
        .send-btn {
            background: linear-gradient(135deg, #4f46e5 0%, #7c3aed 100%);
            color: white;
            border: none;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2rem;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .send-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(79, 70, 229, 0.3);
        }
        
        .send-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }
        
        .language-selector {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        
        .lang-btn {
            padding: 0.5rem 1rem;
            border: 2px solid #e5e7eb;
            background: white;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        
        .lang-btn.active {
            background: #4f46e5;
            color: white;
            border-color: #4f46e5;
        }
        
        .typing-indicator {
            display: none;
            align-items: center;
            gap: 0.5rem;
            padding: 1rem;
            color: #6b7280;
            font-style: italic;
        }
        
        .typing-dots {
            display: flex;
            gap: 0.25rem;
        }
        
        .typing-dot {
            width: 6px;
            height: 6px;
            background: #6b7280;
            border-radius: 50%;
            animation: typingDot 1.4s infinite;
        }
        
        .typing-dot:nth-child(2) { animation-delay: 0.2s; }
        .typing-dot:nth-child(3) { animation-delay: 0.4s; }
        
        .quick-actions {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }
        
        .quick-action {
            padding: 0.5rem 1rem;
            background: rgba(79, 70, 229, 0.1);
            color: #4f46e5;
            border: none;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.9rem;
            transition: all 0.3s ease;
        }
        
        .quick-action:hover {
            background: #4f46e5;
            color: white;
        }
        
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        
        @keyframes typingDot {
            0%, 60%, 100% { transform: translateY(0); }
            30% { transform: translateY(-10px); }
        }
        
        @media (max-width: 768px) {
            .chatbot-container {
                padding: 1rem;
            }
            
            .message {
                max-width: 90%;
            }
            
            .chat-input-area {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <!-- Emergency Mobile Menu Toggle - Always Visible -->
    <div id="emergencyMobileMenu" style="position: fixed; top: 10px; left: 10px; z-index: 999999; display: block;">
        <button onclick="toggleMobileMenu()" style="width: 60px; height: 60px; background: rgba(0,0,0,0.3); border: 2px solid white; color: white; font-size: 24px; font-weight: bold; border-radius: 10px; cursor: pointer; box-shadow: 0 4px 20px rgba(0,0,0,0.8); display: flex; align-items: center; justify-content: center; font-family: Arial;">☰</button>
    </div>
    
    <script>
    function toggleMobileMenu() {
        console.log('Emergency mobile menu clicked!');
        const sidebar = document.getElementById('sidebar');
        const overlay = document.getElementById('sidebarOverlay');
        
        if (sidebar) {
            sidebar.classList.toggle('active');
            sidebar.classList.toggle('open');
            sidebar.style.left = sidebar.style.left === '0px' ? '-100%' : '0px';
        }
        
        if (overlay) {
            overlay.classList.toggle('active');
        }
        
        // Change button appearance
        const btn = event.target;
        btn.innerHTML = btn.innerHTML === '☰' ? '✕' : '☰';
        btn.style.background = btn.innerHTML === '✕' ? 'rgba(0,0,0,0.6)' : 'rgba(0,0,0,0.3)';
    }
    
    // Hide emergency menu on desktop
    function checkScreenSize() {
        const emergencyMenu = document.getElementById('emergencyMobileMenu');
        if (emergencyMenu) {
            emergencyMenu.style.display = window.innerWidth > 1023 ? 'none' : 'block';
        }
    }
    
    window.addEventListener('resize', checkScreenSize);
    window.addEventListener('load', checkScreenSize);
    </script>
    
    <header class="dashboard-header">
        <div class="dashboard-header-top">
            <button class="mobile-menu-toggle" id="mobileMenuToggle">☰</button>
            <h1>AI Chatbot</h1>
        </div>
    </header>

    <div class="sidebar-overlay" id="sidebarOverlay"></div>
    <div class="profile-overlay" id="profileOverlay"></div>

    <!-- Profile Sidebar -->
    <div class="profile-sidebar" id="profileSidebar" role="dialog" aria-labelledby="profileTitle" aria-hidden="true">
        <div class="profile-header">
            <div class="profile-avatar">
                <i class="fas fa-user-circle"></i>
            </div>
            <div class="profile-info">
                <h3 id="profileTitle">Farmer</h3>
                <p id="profileEmail"></p>
            </div>
            <button class="close-profile" id="closeProfile" aria-label="Close profile sidebar">×</button>
        </div>
        <div class="profile-menu">
            <ul role="menu">
                <li role="menuitem" tabindex="0"><i class="fas fa-user"></i> Profile Settings</li>
                <li role="menuitem" tabindex="0"><i class="fas fa-cog"></i> Account Preferences</li>
                <li role="menuitem" tabindex="0"><i class="fas fa-bell"></i> Notifications</li>
                <li role="menuitem" tabindex="0"><i class="fas fa-sign-out-alt"></i> Logout</li>
            </ul>
        </div>
    </div>

    <div class="content-wrapper">
        <div class="dashboard-sidebar" id="sidebar">
            <nav>
                <ul>
                    <li><a href="index.html"><i class="bi bi-person-lines-fill"></i> Dashboard</a></li>
                    <li><a href="crop_recommendation.html"><i class="fas fa-seedling"></i> Crop Recommendation</a></li>
                    <li><a href="schemes.html"><i class="fas fa-chart-bar"></i> Government Schemes</a></li>
                    <li class="active"><a href="chatbot.html"><i class="bi bi-discord"></i> AI Chatbot</a></li>
                    <li><a href="weather.html"><i class="bi bi-cloud-sun-fill"></i> Weather Alerts</a></li>
                    <li><a href="knowledge-base.html"><i class="bi bi-patch-question-fill"></i> Knowledge Base</a></li>
                    <li><a href="marketplace.html"><i class="fas fa-store"></i> Marketplace</a></li>
                    <li><a href="community.html"><i class="bi bi-people-fill"></i> Community Hub</a></li>
                    <li><a href="about.html"><i class="bi bi-chat-fill"></i> About</a></li>
                </ul>
            </nav>
            <div class="dark-toggle" id="darkToggle">🌙 Dark Mode</div>
        </div>

        <main class="dashboard-main-content">
            <div class="chatbot-container">
                <div class="chatbot-header">
                    <h1><i class="fas fa-robot"></i> AI Farming Assistant</h1>
                    <p>Get instant help with farming questions in your preferred language</p>
                </div>

                <div class="chat-interface">
                    <div class="chat-header">
                        <div class="chat-avatar">
                            <i class="fas fa-robot"></i>
                        </div>
                        <div class="chat-info">
                            <h3>Kisan AI Assistant</h3>
                            <p>Ask me about crops, weather, schemes, and farming tips</p>
                        </div>
                    </div>

                    <div class="chat-messages" id="chatMessages">
                        <div class="language-selector">
                            <button class="lang-btn active" data-lang="hi">हिंदी</button>
                            <button class="lang-btn" data-lang="en">English</button>
                            <button class="lang-btn" data-lang="te">తెలుగు</button>
                            <button class="lang-btn" data-lang="ta">தமிழ்</button>
                            <button class="lang-btn" data-lang="kn">ಕನ್ನಡ</button>
                            <button class="lang-btn" data-lang="mr">मराठी</button>
                        </div>

                        <div class="quick-actions">
                            <button class="quick-action" data-action="crop">🌾 Crop Recommendation</button>
                            <button class="quick-action" data-action="weather">🌤️ Weather Info</button>
                            <button class="quick-action" data-action="schemes">🏛️ Government Schemes</button>
                            <button class="quick-action" data-action="help">❓ Help</button>
                        </div>

                        <div class="message bot">
                            <div class="message-avatar">
                                <i class="fas fa-robot"></i>
                            </div>
                            <div class="message-content">
                                <p>नमस्ते! मैं आपका कृषि सहायक हूँ। मैं फसल की सिफारिश, मौसम की जानकारी, सरकारी योजनाओं और खेती की तकनीकों के बारे में मदद कर सकता हूँ। आप मुझसे हिंदी या अंग्रेजी में बात कर सकते हैं।</p>
                                <div class="message-time" id="welcomeTime"></div>
                            </div>
                        </div>

                        <div class="typing-indicator" id="typingIndicator">
                            <div class="typing-dots">
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                                <div class="typing-dot"></div>
                            </div>
                            <span>AI is typing...</span>
                        </div>
                    </div>

                    <div class="chat-input-area">
                        <div class="input-container">
                            <div class="input-wrapper">
                                <textarea 
                                    class="chat-input" 
                                    id="chatInput" 
                                    placeholder="Type your farming question here..."
                                    rows="1"
                                ></textarea>
                                <button class="voice-btn" id="voiceBtn" title="Voice input">
                                    <i class="fas fa-microphone"></i>
                                </button>
                            </div>
                            <button class="send-btn" id="sendBtn" title="Send message">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script src="../assets/js/dark-mode-universal.js"></script>
    <script src="../assets/js/navigation.js"></script>
    <script src="../assets/js/dashboard.js"></script>
    <script src="../assets/js/mobile-responsive.js"></script>
    <script src="../assets/js/ui-enhancements.js"></script>
    <script>
        class ChatbotManager {
            constructor() {
                this.apiBaseUrl = this.getApiBaseUrl();
                this.currentLanguage = 'hi';
                this.isListening = false;
                this.recognition = null;
                this.init();
            }

            getApiBaseUrl() {
                if (window.location.hostname.includes('render.com') || 
                    window.location.hostname.includes('onrender.com')) {
                    return 'https://kisan-sahayak-ml-service.onrender.com';
                }
                return 'http://localhost:8000';
            }

            init() {
                this.setupEventListeners();
                this.setupSpeechRecognition();
                this.updateWelcomeTime();
                this.autoResizeTextarea();
            }

            setupEventListeners() {
                // Send button
                document.getElementById('sendBtn').addEventListener('click', () => {
                    this.sendMessage();
                });

                // Enter key to send
                document.getElementById('chatInput').addEventListener('keypress', (e) => {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        this.sendMessage();
                    }
                });

                // Language selection
                document.querySelectorAll('.lang-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        document.querySelectorAll('.lang-btn').forEach(b => b.classList.remove('active'));
                        btn.classList.add('active');
                        this.currentLanguage = btn.dataset.lang;
                    });
                });

                // Quick actions
                document.querySelectorAll('.quick-action').forEach(btn => {
                    btn.addEventListener('click', () => {
                        this.handleQuickAction(btn.dataset.action);
                    });
                });

                // Voice button
                document.getElementById('voiceBtn').addEventListener('click', () => {
                    this.toggleVoiceInput();
                });
            }

            setupSpeechRecognition() {
                if ('webkitSpeechRecognition' in window || 'SpeechRecognition' in window) {
                    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
                    this.recognition = new SpeechRecognition();
                    this.recognition.continuous = false;
                    this.recognition.interimResults = false;
                    this.recognition.lang = 'hi-IN';

                    this.recognition.onresult = (event) => {
                        const transcript = event.results[0][0].transcript;
                        document.getElementById('chatInput').value = transcript;
                        this.sendMessage();
                    };

                    this.recognition.onend = () => {
                        this.isListening = false;
                        document.getElementById('voiceBtn').classList.remove('listening');
                    };

                    this.recognition.onerror = (event) => {
                        console.error('Speech recognition error:', event.error);
                        this.isListening = false;
                        document.getElementById('voiceBtn').classList.remove('listening');
                    };
                }
            }

            toggleVoiceInput() {
                if (!this.recognition) {
                    alert('Speech recognition not supported in this browser');
                    return;
                }

                if (this.isListening) {
                    this.recognition.stop();
                } else {
                    this.recognition.lang = this.currentLanguage === 'en' ? 'en-US' : 'hi-IN';
                    this.recognition.start();
                    this.isListening = true;
                    document.getElementById('voiceBtn').classList.add('listening');
                }
            }

            async sendMessage() {
                const input = document.getElementById('chatInput');
                const message = input.value.trim();
                
                if (!message) return;

                // Add user message to chat
                this.addMessage(message, 'user');
                input.value = '';
                this.autoResizeTextarea();

                // Show typing indicator
                this.showTypingIndicator();

                try {
                    const response = await this.getAIResponse(message);
                    this.hideTypingIndicator();
                    this.addMessage(response, 'bot');
                    this.speakResponse(response);
                } catch (error) {
                    this.hideTypingIndicator();
                    this.addMessage('Sorry, I encountered an error. Please try again.', 'bot');
                    console.error('Chat error:', error);
                }
            }

            async getAIResponse(message) {
                // Check for specific intents
                if (message.includes('फसल') || message.toLowerCase().includes('crop')) {
                    return await this.getCropRecommendation();
                } else if (message.includes('मौसम') || message.toLowerCase().includes('weather')) {
                    return await this.getWeatherInfo();
                } else if (message.includes('योजना') || message.toLowerCase().includes('scheme')) {
                    return await this.getSchemeInfo();
                } else {
                    return await this.getChatResponse(message);
                }
            }

            async getCropRecommendation() {
                try {
                    const response = await fetch(`${this.apiBaseUrl}/predict_crop`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            N: 90, P: 42, K: 43, ph: 6.5, rainfall: 200, temp: 25
                        })
                    });
                    const data = await response.json();
                    return `आपके खेत की स्थिति के अनुसार सुझाई गई फसल: 🌾 ${data.recommended_crop}\n\nयह सिफारिश मिट्टी के पोषक तत्वों, pH स्तर, बारिश और तापमान के आधार पर की गई है।`;
                } catch (error) {
                    return 'फसल की सिफारिश प्राप्त करने में समस्या हुई। कृपया बाद में पुनः प्रयास करें।';
                }
            }

            async getWeatherInfo() {
                try {
                    const response = await fetch(`${this.apiBaseUrl}/weather/28.6139/77.2090`);
                    const data = await response.json();
                    if (data.main) {
                        return `आज का मौसम: 🌡️ ${Math.round(data.main.temp)}°C\n🌤️ ${data.weather[0].description}\n💧 नमी: ${data.main.humidity}%\n💨 हवा: ${Math.round(data.wind.speed * 3.6)} km/h`;
                    }
                    return 'मौसम की जानकारी प्राप्त करने में समस्या हुई।';
                } catch (error) {
                    return 'मौसम की जानकारी उपलब्ध नहीं है। कृपया बाद में पुनः प्रयास करें।';
                }
            }

            async getSchemeInfo() {
                try {
                    const response = await fetch(`${this.apiBaseUrl}/schemes`);
                    const data = await response.json();
                    let reply = '🏛️ सरकारी कृषि योजनाएं:\n\n';
                    data.schemes.slice(0, 3).forEach((scheme, index) => {
                        reply += `${index + 1}. ${scheme.title}\n   ${scheme.description}\n\n`;
                    });
                    return reply;
                } catch (error) {
                    return 'सरकारी योजनाओं की जानकारी प्राप्त करने में समस्या हुई।';
                }
            }

            async getChatResponse(message) {
                try {
                    const response = await fetch(`${this.apiBaseUrl}/chat`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ text: message, lang: this.currentLanguage })
                    });
                    const data = await response.json();
                    return data.reply;
                } catch (error) {
                    return 'मैं आपकी मदद के लिए तैयार हूँ। कृपया फसल, मौसम या योजना से संबंधित प्रश्न पूछें।';
                }
            }

            handleQuickAction(action) {
                const actions = {
                    crop: 'मुझे फसल की सिफारिश चाहिए',
                    weather: 'आज का मौसम कैसा है?',
                    schemes: 'सरकारी कृषि योजनाओं के बारे में बताएं',
                    help: 'आप मेरी कैसे मदद कर सकते हैं?'
                };
                
                document.getElementById('chatInput').value = actions[action];
                this.sendMessage();
            }

            addMessage(text, sender) {
                const messagesContainer = document.getElementById('chatMessages');
                const messageDiv = document.createElement('div');
                messageDiv.className = `message ${sender}`;
                
                const time = new Date().toLocaleTimeString('en-US', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });

                messageDiv.innerHTML = `
                    <div class="message-avatar">
                        <i class="fas fa-${sender === 'user' ? 'user' : 'robot'}"></i>
                    </div>
                    <div class="message-content">
                        <p>${text.replace(/\n/g, '<br>')}</p>
                        <div class="message-time">${time}</div>
                    </div>
                `;

                messagesContainer.appendChild(messageDiv);
                messagesContainer.scrollTop = messagesContainer.scrollHeight;
            }

            showTypingIndicator() {
                document.getElementById('typingIndicator').style.display = 'flex';
                document.getElementById('chatMessages').scrollTop = document.getElementById('chatMessages').scrollHeight;
            }

            hideTypingIndicator() {
                document.getElementById('typingIndicator').style.display = 'none';
            }

            speakResponse(text) {
                if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(text);
                    utterance.lang = this.currentLanguage === 'en' ? 'en-US' : 'hi-IN';
                    utterance.rate = 0.8;
                    speechSynthesis.speak(utterance);
                }
            }

            updateWelcomeTime() {
                const now = new Date();
                const timeString = now.toLocaleTimeString('en-US', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                document.getElementById('welcomeTime').textContent = timeString;
            }

            autoResizeTextarea() {
                const textarea = document.getElementById('chatInput');
                textarea.style.height = 'auto';
                textarea.style.height = Math.min(textarea.scrollHeight, 120) + 'px';
            }
        }

        // Initialize chatbot
        const chatbot = new ChatbotManager();

        // Set user profile info
        const userData = JSON.parse(localStorage.getItem('user'));
        if (userData && userData.email) {
            document.getElementById('profileEmail').textContent = userData.email;
            if (userData.name && userData.name.length > 0) {
                document.getElementById('profileTitle').textContent = userData.name;
            }
        }

        // Logout functionality
        document.querySelectorAll('.profile-menu ul li').forEach(function (item) {
            if (item.textContent.trim().toLowerCase().includes('logout')) {
                item.addEventListener('click', function () {
                    localStorage.removeItem('user');
                    window.location.href = 'index.html';
                });
            }
        });

        // Auto-resize textarea on input
        document.getElementById('chatInput').addEventListener('input', () => {
            chatbot.autoResizeTextarea();
        });

        // Dark mode toggle functionality
        const darkToggle = document.getElementById('darkToggle');
        if (darkToggle) {
            darkToggle.addEventListener('click', () => {
                document.body.classList.toggle('dark');
                const isDark = document.body.classList.contains('dark');
                darkToggle.textContent = isDark ? '☀️ Light Mode' : '🌙 Dark Mode';
                
                // Save dark mode preference
                localStorage.setItem('darkMode', isDark);
            });

            // Load saved dark mode preference
            const savedDarkMode = localStorage.getItem('darkMode');
            if (savedDarkMode === 'true') {
                document.body.classList.add('dark');
                darkToggle.textContent = '☀️ Light Mode';
            }
        }
    </script>
</body>
</html>